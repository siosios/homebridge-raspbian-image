name: Test Image Artifact

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'GitHub Actions run ID to download artifact from'
        required: true
        type: string
      artifact_name:
        description: 'Artifact name (e.g., raspbian-image-64bit or raspbian-image-32bit)'
        required: true
        type: string
        default: 'raspbian-image-64bit'

jobs:
  test-image:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download artifact from run
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          ls -lh

      - name: Extract image from zip
        run: |
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -n1)
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: No .zip file found in artifact"
            exit 1
          fi
          echo "Found zip file: $ZIP_FILE"
          unzip "$ZIP_FILE"
          echo ""
          echo "Extracted files:"
          ls -lh

      - name: Identify image file
        id: find_image
        run: |
          IMAGE_FILE=$(ls *.img 2>/dev/null | head -n1)
          if [ -z "$IMAGE_FILE" ]; then
            echo "Error: No .img file found after extraction"
            exit 1
          fi
          echo "Found image: $IMAGE_FILE"
          echo "image_path=$IMAGE_FILE" >> $GITHUB_OUTPUT

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk kpartx qemu-user-static

      - name: Analyze image structure
        run: |
          echo "=== Image File Info ==="
          ls -lh ${{ steps.find_image.outputs.image_path }}
          file ${{ steps.find_image.outputs.image_path }}

          echo ""
          echo "=== Partition Table ==="
          fdisk -l ${{ steps.find_image.outputs.image_path }}

      - name: Test mount and extract manifest
        run: |
          mkdir mnt

          # Use losetup to automatically handle partition detection
          LOOP_DEVICE=$(sudo losetup -fP --show ${{ steps.find_image.outputs.image_path }})
          echo "Loop device created: $LOOP_DEVICE"

          # List available partitions
          echo "Available partitions:"
          ls -l ${LOOP_DEVICE}*

          # Try to mount the root partition (usually p2 for Raspberry Pi images)
          echo "Attempting to mount root partition..."
          sudo mount ${LOOP_DEVICE}p2 mnt

          echo ""
          echo "=== Mount successful ==="

          # Check if /opt/homebridge exists
          if [ -d "mnt/opt/homebridge" ]; then
            echo ""
            echo "=== Contents of /opt/homebridge ==="
            ls -lh mnt/opt/homebridge/

            # Look for manifest files
            if ls mnt/opt/homebridge/*manifest 1> /dev/null 2>&1; then
              echo ""
              echo "=== Found manifest files ==="
              cp mnt/opt/homebridge/*manifest .
              ls -lh *manifest

              echo ""
              echo "=== Manifest contents ==="
              for manifest in *manifest; do
                echo "File: $manifest"
                cat "$manifest"
                echo ""
              done
            else
              echo "Warning: No manifest files found in /opt/homebridge/"
            fi
          else
            echo "Error: /opt/homebridge directory not found in image"
            echo ""
            echo "=== Root directory contents ==="
            ls -la mnt/
            echo ""
            echo "=== /opt directory contents ==="
            ls -la mnt/opt/ || echo "/opt does not exist"
          fi

          # Cleanup
          sudo umount mnt
          sudo losetup -d $LOOP_DEVICE
          rm -rf mnt

      - name: Upload manifest files
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: extracted-manifests-${{ inputs.artifact_name }}
          path: '*manifest'
          retention-days: 7
          if-no-files-found: warn

      - name: Test Summary
        if: always()
        run: |
          echo "=== Test Summary ==="
          echo "Run ID: ${{ inputs.run_id }}"
          echo "Artifact: ${{ inputs.artifact_name }}"
          echo "Image: ${{ steps.find_image.outputs.image_path }}"
          echo ""
          if [ -f *manifest ]; then
            echo "✅ Manifest extraction successful"
          else
            echo "❌ Manifest extraction failed"
          fi
