#!/bin/bash
# filepath: /Users/sgracey/Code/homebridge-raspbian-image/stage3_homebridge/01-homebridge/files/hb-config-vnc-uninstall

# VNC and Desktop Uninstall Script for Homebridge Raspberry Pi Image
# This script removes the VNC server and optional desktop components

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\e[1m'
NC='\033[0m'

# Check if running as root
if [ $(id -u) -ne 0 ]; then
  printf "${RED}Script must be run as root. Try 'sudo $0'${NC}\n"
  exit 1
fi

echo -e "${BOLD}VNC and Desktop Uninstall Script${NC}"
echo "This script will remove VNC server and optionally the desktop environment"
echo ""

# Check what's currently installed
VNC_INSTALLED=false
DESKTOP_INSTALLED=false

if systemctl list-unit-files | grep -q "vncserver-x11-serviced.service"; then
  VNC_INSTALLED=true
fi

if dpkg -l | grep -q "^ii.*raspberrypi-ui-mods"; then
  DESKTOP_INSTALLED=true
fi

if [ "$VNC_INSTALLED" = false ] && [ "$DESKTOP_INSTALLED" = false ]; then
  echo -e "${YELLOW}Neither VNC nor desktop environment appears to be installed.${NC}"
  exit 0
fi

# Show what will be removed
echo "Current installation status:"
[ "$VNC_INSTALLED" = true ] && echo "  - VNC Server: INSTALLED"
[ "$VNC_INSTALLED" = false ] && echo "  - VNC Server: not installed"
[ "$DESKTOP_INSTALLED" = true ] && echo "  - Desktop Environment: INSTALLED"
[ "$DESKTOP_INSTALLED" = false ] && echo "  - Desktop Environment: not installed"
echo ""

# Confirm before proceeding
read -p "Do you want to continue with uninstallation? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Uninstallation cancelled."
  exit 0
fi

# Stop and disable VNC services
if [ "$VNC_INSTALLED" = true ]; then
  echo -e "${BOLD}Stopping VNC services...${NC}"
  
  systemctl stop vncserver-x11-serviced.service 2>/dev/null || true
  systemctl disable vncserver-x11-serviced.service 2>/dev/null || true
  
  # Remove any custom VNC service files
  if [ -f /etc/systemd/system/vncserver-pi.service ]; then
    systemctl stop vncserver-pi.service 2>/dev/null || true
    systemctl disable vncserver-pi.service 2>/dev/null || true
    rm -f /etc/systemd/system/vncserver-pi.service
  fi
  
  systemctl daemon-reload
  
  echo -e "${GREEN}VNC services stopped and disabled${NC}"
fi

# Ask about removing VNC package
if [ "$VNC_INSTALLED" = true ]; then
  echo ""
  read -p "Remove RealVNC Server package? (y/N): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${BOLD}Removing RealVNC Server...${NC}"
    apt-get purge -y realvnc-vnc-server 2>/dev/null || true
    apt-get autoremove -y
    echo -e "${GREEN}RealVNC Server removed${NC}"
  fi
fi

# Ask about removing desktop environment
if [ "$DESKTOP_INSTALLED" = true ]; then
  echo ""
  echo -e "${YELLOW}WARNING: Removing the desktop environment will free up ~2GB of disk space${NC}"
  echo -e "${YELLOW}but may take 10-15 minutes to complete.${NC}"
  echo ""
  read -p "Remove desktop environment (raspberrypi-ui-mods)? (y/N): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${BOLD}Removing desktop environment...${NC}"
    echo "This may take several minutes..."
    
    apt-get purge -y raspberrypi-ui-mods 2>/dev/null || true
    apt-get autoremove -y
    apt-get clean
    
    echo -e "${GREEN}Desktop environment removed${NC}"
  fi
fi

echo ""
echo -e "${BOLD}${GREEN}Uninstallation complete!${NC}"
echo ""

# Show final status
echo "Final status:"
systemctl list-unit-files | grep -q "vncserver-x11-serviced.service" && echo "  - VNC Server: still installed" || echo "  - VNC Server: removed"
dpkg -l | grep -q "^ii.*raspberrypi-ui-mods" && echo "  - Desktop Environment: still installed" || echo "  - Desktop Environment: removed"
echo ""

# Suggest reboot if significant changes were made
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${YELLOW}A reboot is recommended to complete the uninstallation.${NC}"
  read -p "Reboot now? (y/N): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    sync
    reboot
  fi
fi

exit 0